(function($){$.fn.tagHandler=function(options){var opts=$.extend($.fn.tagHandler.defaults,options);tagDebug($(this),options);return this.each(function(){if(!$(this).is('ul')){next}if(!this.id){var d=new Date();this.id=d.getTime()}var tagContainer=this;$(tagContainer).addClass(opts.className);if(opts.allowEdit){$(tagContainer).html('<li class="tagInput"><input class="tagInputField" type="text" /></li>')}var inputField=$(tagContainer).find(".tagInputField");var tags=new Array();tags['availableTags']=new Array();tags['originalTags']=new Array();tags['assignedTags']=new Array();if(opts.getURL!=''){$.ajax({url:opts.getURL,cache:false,data:opts.getData,dataType:'json',success:function(data,text,xhr){if(data.availableTags.length){tags['availableTags']=data.availableTags.slice();tags['originalTags']=tags['availableTags'].slice()}if(data.assignedTags.length){tags['assignedTags']=data.assignedTags.slice();for(var x=0;x<tags['assignedTags'].length;x++){if(opts.allowEdit){$("<li />").addClass("tagItem").html(tags['assignedTags'][x]).insertBefore($(inputField))}else{$("<li />").addClass("tagItem").css("cursor","default").html(tags['assignedTags'][x]).appendTo($(tagContainer))}tags['availableTags']=removeTagFromList(tags['assignedTags'][x],tags['availableTags'])}}if(opts.autocomplete&&opts.allowEdit){$(inputField).autocomplete("option","source",tags['availableTags'])}},error:function(xhr,text,error){alert("There was an error getting the tag list.")}})}else{if(opts.availableTags.length){tags['availableTags']=opts.availableTags.slice();tags['originalTags']=tags.availableTags.slice()}if(opts.assignedTags.length){tags['assignedTags']=opts.assignedTags.slice();for(var x=0;x<tags['assignedTags'].length;x++){if(opts.allowEdit){$("<li />").addClass("tagItem").html(tags['assignedTags'][x]).insertBefore($(inputField))}else{$("<li />").addClass("tagItem").css("cursor","default").html(tags['assignedTags'][x]).appendTo($(tagContainer))}tags['availableTags']=removeTagFromList(tags['assignedTags'][x],tags['availableTags'])}}if(opts.autocomplete&&opts.allowEdit){$(inputField).autocomplete("option","source",tags['availableTags'])}}if(opts.allowEdit){$(tagContainer).delegate("#"+this.id+" li.tagItem","click",function(){tags=removeTag($(this),tags,opts.sortTags);if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}});$(tagContainer).click(function(){$(inputField).focus()});$(inputField).keypress(function(e){if(e.which==13||e.which==44||e.which==opts.delimiter.charCodeAt(0)){e.preventDefault();if($(this).val()!=""&&!checkTag($.trim($(this).val()),tags['assignedTags'])){tags=addTag(this,$.trim($(this).val()),tags,opts.sortTags);if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}$(this).val("");$(this).focus()}}});$(inputField).keydown(function(e){if(e.which==8&&$(this).val()==""){tags=removeTag($(tagContainer).find(".tagItem:last"),tags,opts.sortTags);if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}$(this).focus()}});if(opts.autocomplete){$(inputField).autocomplete({source:tags['availableTags'],select:function(event,ui){if(!checkTag($.trim(ui.item.value),tags['assignedTags'])){tags=addTag(this,$.trim(ui.item.value),tags,opts.sortTags);$(inputField).autocomplete("option","source",tags['availableTags']);$(this).focus()}$(this).val("");return false},minLength:0})}}})};$.fn.tagHandler.defaults={assignedTags:[],availableTags:[],getData:'',getURL:'',updatetData:'',updateURL:'',allowEdit:true,autocomplete:true,className:'tagHandler',debug:false,delimiter:'',sortTags:true};function checkTag(value,tags){var check=false;for(var x=0;x<tags.length;x++){if(tags[x]==value){check=true;break}}return check}function removeTagFromList(value,tags){for(var x=0;x<tags.length;x++){if(tags[x]==value){tags.splice(x,1)}}return tags}function addTag(tagField,value,tags,sort){tags['assignedTags'].push(value);tags['availableTags']=removeTagFromList(value,tags['availableTags']);$("<li />").addClass("tagItem").html(value).insertBefore($(tagField));if(sort){tags=sortTags(tags)}return tags}function removeTag(tag,tags,sort){var value=$(tag).html();tags['assignedTags']=removeTagFromList(value,tags['assignedTags']);if(checkTag(value,tags['originalTags'])){tags['availableTags'].push(value)}$(tag).remove();if(sort){tags=sortTags(tags)}return tags}function sortTags(tags){tags['availableTags']=tags['availableTags'].sort();tags['assignedTags']=tags['assignedTags'].sort();tags['originalTags']=tags['originalTags'].sort();return tags}function tagDebug(tagContainer,options){if(window.console&&window.console.log&&options.debug){window.console.log(tagContainer);window.console.log(options);window.console.log($.fn.tagHandler.defaults)}}})(jQuery);