(function(e){e.fn.tagHandler=function(j){var k=e.extend({},e.fn.tagHandler.defaults,j);c(e(this),k);return this.each(function(){if(!e(this).is("ul")){return true}var o=this;if(!o.id){var p=new Date();o.id=p.getTime()}e(o).wrap('<div class="'+k.className+'" />');e(o).addClass(k.className+"Container");if(k.allowEdit){e(o).html('<li class="tagInput"><input class="tagInputField" type="text" /></li>')}var l=e(o).find(".tagInputField");var n=[];n.availableTags=[];n.originalTags=[];n.assignedTags=[];if(k.updateURL!==""){if(!k.autoUpdate){e("<div />").attr({id:o.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){i(n,k,o.id)}).appendTo(e(o).parent())}e("<div />").attr({id:o.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(e(o).parent())}if(k.getURL!==""&&k.initLoad){e.ajax({url:k.getURL,cache:false,data:k.getData,dataType:"json",success:function(q,s,r){if(q.availableTags.length){n.availableTags=q.availableTags.slice();n.originalTags=n.availableTags.slice()}if(k.sortTags){n=g(n)}if(q.assignedTags.length){n.assignedTags=q.assignedTags.slice();if(k.sortTags){n=g(n)}n=a(k,n,l,o)}if(k.autocomplete&&k.allowEdit){e(l).autocomplete("option","source",n.availableTags)}},error:function(s,r,q){c(s,r,q);alert(k.msgError)}})}else{if(k.getURL!==""){n.assignedTags=k.assignedTags.slice();if(k.sortTags){n=g(n)}n=a(k,n,l,o)}else{if(k.availableTags.length){n.availableTags=k.availableTags.slice();n.originalTags=n.availableTags.slice()}if(k.sortTags){n=g(n)}if(k.assignedTags.length){n.assignedTags=k.assignedTags.slice();if(k.sortTags){n=g(n)}n=a(k,n,l,o)}if(k.autocomplete&&k.allowEdit&&k.initLoad){e(l).autocomplete("option","source",n.availableTags)}}}if(k.allowEdit){e(o).delegate("li.tagItem","click",function(){n=h(e(this),n,k.sortTags);if(k.updateURL!==""&&k.autoUpdate){i(n,k,o.id)}if(k.autocomplete&&k.initLoad){e(l).autocomplete("option","source",n.availableTags)}});e(l).keypress(function(q){if(q.which===13||q.which===44||q.which===k.delimiter.charCodeAt(0)){q.preventDefault();if(e(this).val()!==""&&!d(e.trim(e(this).val()),n.assignedTags)){if(!k.allowAdd&&!d(e.trim(e(this).val()),n.availableTags)){alert(k.msgNoNewTag);return}n=b(this,e.trim(e(this).val()),n,k.sortTags);if(k.updateURL!==""&&k.autoUpdate){i(n,k,o.id)}if(k.autocomplete&&k.initLoad){e(l).autocomplete("option","source",n.availableTags)}e(this).val("");e(this).focus()}}});e(l).keydown(function(q){if(q.which===8&&e(this).val()===""){n=h(e(o).find(".tagItem:last"),n,k.sortTags);if(k.updateURL!==""&&k.autoUpdate){i(n,k,o.id)}if(k.autocomplete&&k.initLoad){e(l).autocomplete("option","source",n.availableTags)}e(this).focus()}});if(k.autocomplete&&k.initLoad){e(l).autocomplete({source:n.availableTags,select:function(q,r){if(!d(e.trim(r.item.value),n.assignedTags)){n=b(this,e.trim(r.item.value),n,k.sortTags);if(k.updateURL!==""&&k.autoUpdate){i(n,k,o.id)}e(l).autocomplete("option","source",n.availableTags);e(this).focus()}e(this).val("");return false},minLength:k.minChars})}else{if(k.autocomplete){var m={};e(l).autocomplete({source:function(s,q){var r=s.term;if(r in m){q(m[r]);return}k.getData[k.queryName]=r;lastXhr=e.getJSON(k.getURL,k.getData,function(u,t,v){m[r]=u;if(v===lastXhr){q(u)}})},select:function(q,r){if(!d(e.trim(r.item.value),n.assignedTags)){n=b(this,e.trim(r.item.value),n,k.sortTags);if(k.updateURL!==""&&k.autoUpdate){i(n,k,o.id)}e(this).focus()}e(this).val("");return false},minLength:k.minChars})}}e(l).focus(function(){if(e(l).val()===""&&k.autocomplete&&k.initLoad){e(l).autocomplete("search","")}});e(o).click(function(){e(l).focus()})}})};e.fn.tagHandler.defaults={allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:"tagHandler",queryName:"q",debug:false,delimiter:"",getData:"",getURL:"",initLoad:true,sortTags:true,updatetData:"",updateURL:"",minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list."};function d(l,k){var j=false;e(k).each(function(m,n){if(n===l){j=true;return false}});return j}function f(k,j){e(j).each(function(l,m){if(m===k){j.splice(l,1)}});return j}function b(j,m,k,l){k.assignedTags.push(m);k.availableTags=f(m,k.availableTags);e("<li />").addClass("tagItem").html(m).insertBefore(e(j).parent());if(l){k=g(k)}return k}function h(j,k,l){var m=e(j).html();k.assignedTags=f(m,k.assignedTags);if(d(m,k.originalTags)){k.availableTags.push(m)}e(j).remove();if(l){k=g(k)}return k}function g(j){j.availableTags=j.availableTags.sort();j.assignedTags=j.assignedTags.sort();j.originalTags=j.originalTags.sort();return j}function i(j,l,k){sendData={tags:j.assignedTags};e.extend(sendData,l.updateData);e.ajax({type:"POST",url:l.updateURL,cache:false,data:sendData,dataType:"json",beforeSend:function(){if(e("#"+k+"_save").length){e("#"+k+"_save").fadeOut(200,function(){e("#"+k+"_loader").fadeIn(200)})}else{e("#"+k+"_loader").fadeIn(200)}},complete:function(){e("#"+k+"_loader").fadeOut(200,function(){if(e("#"+k+"_save").length){e("#"+k+"_save").fadeIn(200)}})}})}function a(l,k,j,m){e(k.assignedTags).each(function(n,o){if(l.allowEdit){e("<li />").addClass("tagItem").html(o).insertBefore(e(j).parent())}else{e("<li />").addClass("tagItem").css("cursor","default").html(o).appendTo(e(m))}k.availableTags=f(o,k.availableTags)});return k}function c(k,j){if(window.console&&window.console.log&&j.debug){window.console.log(k);window.console.log(j);window.console.log(e.fn.tagHandler.defaults)}}})(jQuery);